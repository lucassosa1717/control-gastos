{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
{% if user.is_authenticated %}
    <!-- Contenido para usuarios autenticados -->
    <div class="container-fluid">
        <!-- Resumen Financiero -->
        {% if salario_configurado %}
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card text-white {% if perfil.saldo_disponible >= 0 %}bg-success{% else %}bg-danger{% endif %} shadow-lg">
                        <div class="card-body text-center">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-2">Saldo Disponible</h6>
                                    <h3 class="mb-0">
                                        <i class="fas fa-wallet me-2"></i>${{ perfil.saldo_disponible|floatformat:0 }}
                                    </h3>
                                </div>
                                <div class="ms-2">
                                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#editSaldoModal" title="Editar Saldo">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card text-white bg-info shadow-lg">
                        <div class="card-body text-center">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-2">Gastos del Mes</h6>
                                    <h3 class="mb-0">
                                        <i class="fas fa-shopping-cart me-2"></i>${{ total_mes_actual|floatformat:0 }}
                                    </h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sección Principal: Agregar Gasto -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-lg border-0 mb-4">
                        <div class="card-header bg-gradient-expense py-4">
                            <!-- Contenido del header -->
                            <div class="text-center">
                                <h3 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Agregar Nuevo Gasto</h3>
                                <p class="mb-0 opacity-75">Gestiona tus gastos de manera inteligente</p>
                            </div>
                            
                            <!-- Botones de acciones principales -->
                            <div class="d-flex justify-content-center mt-3 gap-2">
                                <button class="btn" style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white;" type="button" data-bs-toggle="modal" data-bs-target="#gastosFijosModal">
                                    <i class="fas fa-calendar-alt me-2"></i>Gastos Fijos
                                </button>
                                <button class="btn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;" type="button" data-bs-toggle="modal" data-bs-target="#historialMercadoPagoModal">
                                    <i class="fas fa-file-image me-2"></i>Subir Historial
                                </button>
                                <button class="btn" style="background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white;" type="button" data-bs-toggle="modal" data-bs-target="#tarjetaCreditoModal">
                                    <i class="fas fa-credit-card me-2"></i>RESUMEN TARJETA
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <!-- Mostrar mensajes -->
                            {% if messages %}
                                {% for message in messages %}
                                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                            
                            <form method="post" enctype="multipart/form-data" class="gasto-form">
                                {% csrf_token %}
                                
                                <div class="row g-3">
                                    <!-- Descripción -->
                                    <div class="col-12 col-md-8">
                                        <label for="{{ gasto_form.descripcion.id_for_label }}" class="form-label fw-bold">
                                            <i class="fas fa-tag me-2 text-primary"></i>Descripción
                                        </label>
                                        {{ gasto_form.descripcion|add_class:"form-control" }}
                                    </div>
                                    
                                    <!-- Monto -->
                                    <div class="col-12 col-md-4">
                                        <label for="{{ gasto_form.monto.id_for_label }}" class="form-label fw-bold">
                                            <i class="fas fa-dollar-sign me-2 text-success"></i>Monto
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            {{ gasto_form.monto|add_class:"form-control" }}
                                        </div>
                                    </div>
                                    

                                    

                                </div>
                                
                                <!-- Botón agregar -->
                                <div class="text-center mt-4">
                                    <button type="submit" name="gasto_submit" class="btn btn-primary btn-lg px-5">
                                        <i class="fas fa-plus me-2"></i>Agregar Gasto
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gastos Recientes -->
            {% if gastos_recientes %}
            <div class="row mt-3 mt-md-5">
                <div class="col-12">
                    <div class="card shadow-lg border-0">
                        <div class="card-header bg-light py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 text-dark h6 h5-md"><i class="fas fa-history me-2"></i>Gastos Recientes</h5>
                                {% if gastos_recientes.has_other_pages %}
                                <div class="pagination-sm">
                                    <nav aria-label="Paginación de gastos">
                                        <ul class="pagination pagination-sm mb-0">
                                            {% if gastos_recientes.has_previous %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ gastos_recientes.previous_page_number }}" aria-label="Anterior">
                                                        <span aria-hidden="true">&laquo;</span>
                                                    </a>
                                                </li>
                                            {% endif %}
                                            
                                            {% for num in gastos_recientes.paginator.page_range %}
                                                {% if gastos_recientes.number == num %}
                                                    <li class="page-item active">
                                                        <span class="page-link">{{ num }}</span>
                                                    </li>
                                                {% elif num > gastos_recientes.number|add:'-3' and num < gastos_recientes.number|add:'3' %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                            
                                            {% if gastos_recientes.has_next %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ gastos_recientes.next_page_number }}" aria-label="Siguiente">
                                                        <span aria-hidden="true">&raquo;</span>
                                                    </a>
                                                </li>
                                            {% endif %}
                                        </ul>
                                    </nav>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-3">
                                {% for gasto in gastos_recientes %}
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title mb-1">{{ gasto.descripcion }}</h6>
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar-alt me-1"></i>
                                                        {{ gasto.fecha|date:"d/m/Y H:i" }}
                                                    </small>
                                                </div>
                                                <div class="d-flex align-items-center gap-3">
                                                    <span class="badge bg-danger fs-5 px-3 py-2">-${{ gasto.monto|floatformat:0 }}</span>
                                                    <div class="d-flex gap-2">
                                                        <button type="button" class="btn btn-primary btn-sm shadow-sm" 
                                                                onclick="editarGasto({{ gasto.id }}, '{{ gasto.descripcion|escapejs }}', {{ gasto.monto }})"
                                                                title="Editar gasto">
                                                            <i class="fas fa-edit me-1"></i>Editar
                                                        </button>
                                                        <button type="button" class="btn btn-danger btn-sm shadow-sm" 
                                                                onclick="eliminarGasto({{ gasto.id }})"
                                                                title="Eliminar gasto">
                                                            <i class="fas fa-trash me-1"></i>Eliminar
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% else %}
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-header text-center">
                            <h3 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Configura tu Salario</h3>
                        </div>
                        <div class="card-body text-center">
                            <p class="lead text-muted mb-4">Primero necesitas configurar tu salario mensual para comenzar a gestionar tus gastos.</p>
                            <a href="{% url 'actualizar_salario' %}" class="btn btn-primary btn-lg">
                                <i class="fas fa-plus me-2"></i>Configurar Salario
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
{% else %}
    <!-- Contenido para usuarios no autenticados -->
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <div class="card">
                <div class="card-body py-5">
                    <h1 class="display-4 mb-4">¡Bienvenido a Control de Gastos!</h1>
                    <p class="lead mb-4">Gestiona tus finanzas personales de manera fácil y eficiente</p>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{% url 'login' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión
                        </a>
                        <a href="{% url 'registro' %}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-user-plus me-2"></i>Registrarse
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<style>
.bg-gradient {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.bg-gradient-expense {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white !important;
}

.salario-principal {
    padding: 2rem;
    border-radius: 1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin: 0 auto;
    max-width: 600px;
}

.input-group-lg .form-control {
    border-radius: 0 0.5rem 0.5rem 0;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.input-group-lg .input-group-text {
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.input-group-lg .form-control:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.input-group-lg .form-control:focus ~ .input-group-text {
    border-color: #28a745;
}

.card {
    border-radius: 1rem;
}

.btn-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.btn-success:hover {
    background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
}

.btn-outline-secondary {
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.btn-outline-secondary:hover {
    transform: translateY(-2px);
}

/* Estilos para el formulario de gastos */
.gasto-form .form-control {
    border-radius: 0.5rem;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.gasto-form .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.gasto-form .input-group-text {
    background: #007bff;
    color: white;
    border: 2px solid #007bff;
    border-radius: 0.5rem 0 0 0.5rem;
}

.btn-primary {
    background-color: #007bff;
    border: none;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
}

/* Animación para nuevos gastos */
.table-hover tbody tr:hover {
    background-color: #f8f9fa;
    transform: scale(1.01);
    transition: all 0.2s ease;
}

/* Indicador de saldo */
.saldo-indicator {
    font-size: 1.1em;
    font-weight: bold;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* Responsive improvements */
@media (max-width: 768px) {
    .col-md-6, .col-md-3 {
        margin-bottom: 1rem;
    }
    
    .btn-lg {
        padding: 0.75rem 2rem;
        font-size: 1rem;
    }
    
    .salario-principal {
        padding: 1.5rem;
    }
    
    .display-4 {
        font-size: 2.5rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const montoInput = document.querySelector('#id_monto');
    const submitBtn = document.querySelector('button[name="gasto_submit"]');
    const saldoDisponible = {{ perfil.saldo_disponible|default:0 }};
    
    if (montoInput) {
        montoInput.addEventListener('input', function() {
            const monto = parseFloat(this.value) || 0;
            const nuevoSaldo = saldoDisponible - monto;
            
            // Actualizar color del botón según el saldo
            if (monto > saldoDisponible) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Saldo Insuficiente';
                submitBtn.className = 'btn btn-danger btn-lg px-5';
                this.style.borderColor = '#dc3545';
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Agregar Gasto';
                submitBtn.className = 'btn btn-primary btn-lg px-5';
                this.style.borderColor = monto > 0 ? '#28a745' : '#e9ecef';
            }
            
            // Mostrar preview del nuevo saldo
            if (monto > 0) {
                const preview = document.querySelector('.saldo-preview');
                if (preview) {
                    preview.remove();
                }
                
                const previewElement = document.createElement('small');
                previewElement.className = 'saldo-preview text-muted d-block mt-1';
                previewElement.innerHTML = `Saldo después del gasto: <strong class="${nuevoSaldo >= 0 ? 'text-success' : 'text-danger'}">$${nuevoSaldo.toFixed(2)}</strong>`;
                this.parentElement.appendChild(previewElement);
            } else {
                const preview = document.querySelector('.saldo-preview');
                if (preview) {
                    preview.remove();
                }
            }
        });
    }
    
    // Animación para mensajes de éxito/error
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-20px)';
            setTimeout(() => alert.remove(), 300);
        }, 5000);
    });
    
    // Auto-focus en el primer campo del formulario de gastos
    const descripcionInput = document.querySelector('#id_descripcion');
    if (descripcionInput && {{ salario_configurado|yesno:"true,false" }}) {
        setTimeout(() => descripcionInput.focus(), 500);
    }
});
</script>

<!-- Modal de Editar Gasto -->
<div class="modal fade" id="editarGastoModal" tabindex="-1" aria-labelledby="editarGastoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editarGastoModalLabel">
                    <i class="fas fa-edit me-2"></i>Editar Gasto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editarGastoForm">
                    {% csrf_token %}
                    <input type="hidden" id="editGastoId" name="gasto_id">
                    
                    <div class="mb-3">
                        <label for="editDescripcion" class="form-label fw-bold">
                            <i class="fas fa-tag me-2 text-primary"></i>Descripción
                        </label>
                        <input type="text" class="form-control" id="editDescripcion" name="descripcion" 
                               placeholder="Descripción del gasto" required>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-12 col-sm-6">
                            <label for="editMonto" class="form-label fw-bold">
                                <i class="fas fa-dollar-sign me-2 text-success"></i>Monto
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editMonto" name="monto" 
                                       step="0.01" placeholder="0.00" required style="-webkit-appearance: textfield; -moz-appearance: textfield;" onkeypress="return event.charCode >= 48 && event.charCode <= 57 || event.charCode == 46" oninput="this.value = this.value.replace(/[^0-9.]/g, ''); if(this.value < 0) this.value = Math.abs(this.value);">
                            </div>
                        </div>
                        

                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white;" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarCambiosGasto()">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Gastos Fijos -->
<div class="modal fade" id="gastosFijosModal" tabindex="-1" aria-labelledby="gastosFijosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);">
                <h5 class="modal-title" id="gastosFijosModalLabel">
                    <i class="fas fa-calendar-alt me-2"></i>Gestión de Gastos Fijos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Formulario para agregar gasto fijo -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-plus me-2"></i>Agregar Nuevo Gasto Fijo</h6>
                    </div>
                    <div class="card-body">
                        <div id="gastoFijoFormContainer">
                            <!-- El formulario se cargará aquí -->
                        </div>
                        <div class="d-grid mt-4">
                            <button type="button" class="btn" style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white;" id="btnAgregarGastoFijo">
                                <i class="fas fa-save me-2"></i>Guardar
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de gastos fijos -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-list me-2"></i>Gastos Fijos Guardados</h6>
                    </div>
                    <div class="card-body">
                        <div id="gastosFijosList">
                            <!-- La lista se cargará aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Historial MercadoPago -->
<div class="modal fade" id="historialMercadoPagoModal" tabindex="-1" aria-labelledby="historialMercadoPagoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <h5 class="modal-title" id="historialMercadoPagoModalLabel">
                    <i class="fas fa-file-image me-2"></i>Subir Historial
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Instrucciones:</strong> Sube una captura de pantalla de tu historial de MercadoPago. 
                    El sistema extraerá automáticamente todos los gastos con descripción, monto, fecha y prioridad.
                </div>
                
                <form id="historialMercadoPagoForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="historial_submit" value="1">
                    
                    <div class="mb-4">
                        <label for="historial_imagen" class="form-label fw-bold">
                            <i class="fas fa-upload me-2 text-info"></i>Seleccionar Imagen del Historial
                        </label>
                        <input type="file" class="form-control" id="historial_imagen" name="historial_imagen" 
                               accept="image/*" required>
                        <div class="form-text">
                            Formatos soportados: JPG, PNG, JPEG. Tamaño máximo: 10MB
                        </div>
                    </div>
                    
                    <div id="historialPreview" class="mb-3" style="display: none;">
                        <label class="form-label fw-bold">Vista previa:</label>
                        <img id="historialImagePreview" src="" alt="Vista previa" class="img-fluid rounded border" style="max-height: 300px;">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white;" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;" id="btnProcesarHistorial">
                    <i class="fas fa-magic me-2"></i>Procesar Historial
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Estado de Cuenta Tarjeta de Crédito -->
<div class="modal fade" id="tarjetaCreditoModal" tabindex="-1" aria-labelledby="tarjetaCreditoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);">
                <h5 class="modal-title" id="tarjetaCreditoModalLabel">
                    <i class="fas fa-credit-card me-2"></i>RESUMEN TARJETA - Tarjeta de Crédito
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Instrucciones:</strong> Sube el PDF de tu estado de cuenta de tarjeta de crédito. 
                    El sistema extraerá automáticamente el total a pagar y lo agregará a tus gastos.
                </div>
                
                <form id="tarjetaCreditoForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="tarjeta_credito_submit" value="1">
                    
                    <div class="mb-4">
                        <label for="tarjeta_pdf" class="form-label fw-bold">
                            <i class="fas fa-file-pdf me-2 text-danger"></i>Seleccionar PDF del Estado de Cuenta
                        </label>
                        <input type="file" class="form-control" id="tarjeta_pdf" name="tarjeta_pdf" 
                               accept=".pdf" required>
                        <div class="form-text">
                            Solo archivos PDF. Tamaño máximo: 10MB
                        </div>
                    </div>
                    
                    <div id="pdfPreview" class="mb-3" style="display: none;">
                        <label class="form-label fw-bold">Archivo seleccionado:</label>
                        <div class="d-flex align-items-center p-3 bg-light rounded">
                            <i class="fas fa-file-pdf text-danger me-2 fa-2x"></i>
                            <div>
                                <div id="pdfFileName" class="fw-bold"></div>
                                <div id="pdfFileSize" class="text-muted small"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="btnProcesarTarjeta">
                    <i class="fas fa-magic me-2"></i>Procesar Estado de Cuenta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Saldo -->
<div class="modal fade" id="editSaldoModal" tabindex="-1" aria-labelledby="editSaldoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editSaldoModalLabel">
                    <i class="fas fa-edit me-2"></i>Editar Saldo Disponible
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Nota:</strong> Este cambio actualizará tu saldo disponible actual.
                </div>
                
                <form id="editSaldoForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="edit_saldo_submit" value="1">
                    
                    <div class="mb-3">
                        <label for="nuevo_saldo" class="form-label fw-bold">
                            <i class="fas fa-dollar-sign me-2 text-success"></i>Nuevo Saldo Disponible
                        </label>
                        <input type="number" class="form-control" id="nuevo_saldo" name="nuevo_saldo" 
                               value="{{ perfil.saldo_disponible }}" step="0.01" required>
                        <div class="form-text">
                            Ingresa el nuevo monto de tu saldo disponible
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnGuardarSaldo">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Gasto Fijo -->
<div class="modal fade" id="editarGastoFijoModal" tabindex="-1" aria-labelledby="editarGastoFijoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editarGastoFijoModalLabel">
                    <i class="fas fa-edit me-2"></i>Editar Gasto Fijo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editarGastoFijoForm">
                    {% csrf_token %}
                    <input type="hidden" id="editGastoFijoId" name="editar_gasto_fijo_id">
                    
                    <div class="mb-3">
                        <label for="editGastoFijoDescripcion" class="form-label fw-bold">
                            <i class="fas fa-tag me-2 text-primary"></i>Descripción
                        </label>
                        <input type="text" class="form-control" id="editGastoFijoDescripcion" name="descripcion" 
                               placeholder="Descripción del gasto fijo" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editGastoFijoMonto" class="form-label fw-bold">
                            <i class="fas fa-dollar-sign me-2 text-success"></i>Monto
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="editGastoFijoMonto" name="monto" 
                                   step="0.01" placeholder="0.00" required style="-webkit-appearance: textfield; -moz-appearance: textfield;" 
                                   onkeypress="return event.charCode >= 48 && event.charCode <= 57 || event.charCode == 46" 
                                   oninput="this.value = this.value.replace(/[^0-9.]/g, ''); if(this.value < 0) this.value = Math.abs(this.value);">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarCambiosGastoFijo()">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript para manejar gastos fijos
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('gastosFijosModal');
    const btnAgregar = document.getElementById('btnAgregarGastoFijo');
    
    // Cargar formulario y lista cuando se abre el modal
    modal.addEventListener('show.bs.modal', function() {
        cargarFormularioGastoFijo();
        cargarGastosFijos();
    });
    
    // Agregar gasto fijo
    btnAgregar.addEventListener('click', function() {
        const form = document.getElementById('gastoFijoForm');
        if (form) {
            const formData = new FormData(form);
            
            fetch('{% url "gastos_fijos" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarAlerta('Gasto fijo agregado correctamente', 'success');
                    form.reset();
                    cargarGastosFijos();
                } else {
                    mostrarAlerta(data.error || 'Error al agregar gasto fijo', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error de conexión', 'danger');
            });
        }
    });
    
    // Función para cargar el formulario
    function cargarFormularioGastoFijo() {
        fetch('{% url "gastos_fijos" %}?get_form=1')
        .then(response => response.text())
        .then(html => {
            document.getElementById('gastoFijoFormContainer').innerHTML = html;
        })
        .catch(error => {
            console.error('Error al cargar formulario:', error);
        });
    }
    
    // Función para cargar la lista de gastos fijos
    function cargarGastosFijos() {
        fetch('{% url "gastos_fijos" %}?get_list=1')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('gastosFijosList');
            if (data.gastos_fijos && data.gastos_fijos.length > 0) {
                let html = '';
                let totalGastosFijos = 0;
                
                data.gastos_fijos.forEach(gasto => {
                    // Sumar al total
                    totalGastosFijos += parseFloat(gasto.monto);
                    
                    html += `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <strong>${gasto.descripcion}</strong>
                                <span class="text-muted">- $${gasto.monto}</span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-success me-2" onclick="aplicarGastoFijo(${gasto.id})">
                                    <i class="fas fa-check"></i> Aplicar
                                </button>
                                <button class="btn btn-sm btn-warning me-2" onclick="editarGastoFijo(${gasto.id}, '${gasto.descripcion}', ${gasto.monto})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="eliminarGastoFijo(${gasto.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                // Agregar el total al final
                html += `
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                        <div>
                            <strong class="text-primary">TOTAL GASTOS FIJOS</strong>
                        </div>
                        <div>
                            <strong class="text-primary">$${totalGastosFijos.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="text-muted text-center">No hay gastos fijos guardados</p>';
            }
        })
        .catch(error => {
            console.error('Error al cargar gastos fijos:', error);
        });
    }
    
    // Función para aplicar gasto fijo
    window.aplicarGastoFijo = function(gastoId) {
        fetch('{% url "gastos_fijos" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `aplicar_gasto_fijo=${gastoId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('Gasto aplicado correctamente. El gasto fijo permanece en la lista para futuros usos.', 'success');
                // No cerramos el modal ni recargamos la página para mantener los gastos fijos visibles
            } else {
                mostrarAlerta(data.error || 'Error al aplicar gasto', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarAlerta('Error de conexión', 'danger');
        });
    };
    
    // Función para eliminar gasto fijo
    window.eliminarGastoFijo = function(gastoId) {
        if (confirm('¿Estás seguro de que quieres eliminar este gasto fijo?')) {
            fetch('{% url "gastos_fijos" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `eliminar_gasto_fijo=${gastoId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarAlerta('Gasto fijo eliminado', 'success');
                    cargarGastosFijos();
                } else {
                    mostrarAlerta(data.error || 'Error al eliminar gasto', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error de conexión', 'danger');
            });
        }
    };
    
    // Funciones para editar y eliminar gastos
    window.editarGasto = function(gastoId, descripcion, monto) {
        // Llenar el modal con los datos del gasto
        document.getElementById('editGastoId').value = gastoId;
        document.getElementById('editDescripcion').value = descripcion;
        document.getElementById('editMonto').value = monto;
        
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('editarGastoModal'));
        modal.show();
    };
    
    // Función para editar gasto fijo
    window.editarGastoFijo = function(gastoId, descripcion, monto) {
        // Llenar el modal con los datos del gasto fijo
        document.getElementById('editGastoFijoId').value = gastoId;
        document.getElementById('editGastoFijoDescripcion').value = descripcion;
        document.getElementById('editGastoFijoMonto').value = monto;
        
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('editarGastoFijoModal'));
        modal.show();
    };
    
    // Función para guardar cambios del gasto fijo editado
    window.guardarCambiosGastoFijo = function() {
        const form = document.getElementById('editarGastoFijoForm');
        const formData = new FormData(form);
        
        fetch('{% url "gastos_fijos" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('Gasto fijo actualizado correctamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editarGastoFijoModal')).hide();
                cargarGastosFijos();
            } else {
                mostrarAlerta(data.error || 'Error al actualizar el gasto fijo', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarAlerta('Error de conexión', 'danger');
        });
    };
    
    window.eliminarGasto = function(gastoId) {
        if (confirm('¿Estás seguro de que quieres eliminar este gasto?')) {
            fetch(`/eliminar-gasto/${gastoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    mostrarAlerta('Gasto eliminado correctamente', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    mostrarAlerta('Error al eliminar el gasto', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error de conexión', 'danger');
            });
        }
    };
    
    // Función para guardar cambios del gasto editado
    window.guardarCambiosGasto = function() {
        const form = document.getElementById('editarGastoForm');
        const formData = new FormData(form);
        
        fetch('{% url "editar_gasto" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('Gasto actualizado correctamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editarGastoModal')).hide();
                setTimeout(() => location.reload(), 1000);
            } else {
                mostrarAlerta(data.error || 'Error al actualizar el gasto', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarAlerta('Error de conexión', 'danger');
        });
    };
    
    // Función para mostrar alertas
    function mostrarAlerta(mensaje, tipo) {
        const alertContainer = document.querySelector('.container-fluid');
        const alert = document.createElement('div');
        alert.className = `alert alert-${tipo} alert-dismissible fade show mt-3`;
        alert.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.insertBefore(alert, alertContainer.firstChild);
        
        // Auto-dismiss después de 3 segundos
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 3000);
    }
    
    // JavaScript para manejar historial de MercadoPago
    const historialImageInput = document.getElementById('historial_imagen');
    const historialPreview = document.getElementById('historialPreview');
    const historialImagePreview = document.getElementById('historialImagePreview');
    const btnProcesarHistorial = document.getElementById('btnProcesarHistorial');
    
    // Vista previa de imagen
    if (historialImageInput) {
        historialImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    historialImagePreview.src = e.target.result;
                    historialPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                historialPreview.style.display = 'none';
            }
        });
    }
    
    // Procesar historial
    if (btnProcesarHistorial) {
        btnProcesarHistorial.addEventListener('click', function() {
            const form = document.getElementById('historialMercadoPagoForm');
            const formData = new FormData(form);
            
            if (!historialImageInput.files[0]) {
                mostrarAlerta('Por favor selecciona una imagen', 'warning');
                return;
            }
            
            // Asegurar que se incluya el campo historial_submit
            formData.set('historial_submit', '1');
            
            // Mostrar loading
            btnProcesarHistorial.disabled = true;
            btnProcesarHistorial.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarAlerta(`Historial procesado exitosamente. Se agregaron ${data.gastos_agregados} gastos.`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('historialMercadoPagoModal')).hide();
                    setTimeout(() => location.reload(), 2000);
                } else {
                    mostrarAlerta(data.error || 'Error al procesar el historial', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error de conexión', 'danger');
            })
            .finally(() => {
                btnProcesarHistorial.disabled = false;
                btnProcesarHistorial.innerHTML = '<i class="fas fa-magic me-2"></i>Procesar Historial';
            });
        });    }
    
    // JavaScript para manejar tarjeta de crédito
    const tarjetaPdfInput = document.getElementById('tarjeta_pdf');
    const pdfPreview = document.getElementById('pdfPreview');
    const pdfFileName = document.getElementById('pdfFileName');
    const pdfFileSize = document.getElementById('pdfFileSize');
    const btnProcesarTarjeta = document.getElementById('btnProcesarTarjeta');
    
    // Preview del PDF
    if (tarjetaPdfInput) {
        tarjetaPdfInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                pdfFileName.textContent = file.name;
                pdfFileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                pdfPreview.style.display = 'block';
            } else {
                pdfPreview.style.display = 'none';
            }
        });
    }
    
    // Procesar PDF de tarjeta de crédito
    if (btnProcesarTarjeta) {
        btnProcesarTarjeta.addEventListener('click', function() {
            const form = document.getElementById('tarjetaCreditoForm');
            const formData = new FormData(form);
            
            if (!tarjetaPdfInput.files[0]) {
                mostrarAlerta('Por favor selecciona un archivo PDF', 'warning');
                return;
            }
            
            // Asegurar que se incluya el campo tarjeta_credito_submit
            formData.set('tarjeta_credito_submit', '1');
            
            // Mostrar loading
            btnProcesarTarjeta.disabled = true;
            btnProcesarTarjeta.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarAlerta(`Estado de cuenta procesado exitosamente. Total agregado: $${data.total_agregado}`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('tarjetaCreditoModal')).hide();
                    setTimeout(() => location.reload(), 2000);
                } else {
                    mostrarAlerta(data.error || 'Error al procesar el estado de cuenta', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error de conexión', 'danger');
            })
            .finally(() => {
                btnProcesarTarjeta.disabled = false;
                btnProcesarTarjeta.innerHTML = '<i class="fas fa-magic me-2"></i>Procesar Estado de Cuenta';
            });
        });
    }
    
    // JavaScript para manejar edición de saldo
    const btnGuardarSaldo = document.getElementById('btnGuardarSaldo');
    
    if (btnGuardarSaldo) {
        btnGuardarSaldo.addEventListener('click', function() {
            const form = document.getElementById('editSaldoForm');
            const formData = new FormData(form);
            
            // Deshabilitar botón mientras se procesa
            btnGuardarSaldo.disabled = true;
            btnGuardarSaldo.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarAlerta('Saldo actualizado correctamente', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editSaldoModal')).hide();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    mostrarAlerta(data.error || 'Error al actualizar el saldo', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error de conexión', 'danger');
            })
            .finally(() => {
                btnGuardarSaldo.disabled = false;
                btnGuardarSaldo.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Cambios';
            });
        });
    }
});
</script>

{% endblock %}